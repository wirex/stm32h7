### 요구사항 : 

1. ADC 로 배터리 전압, 전류를 측정하는 함수를 구현
ADC 작동모드 - MCU 가 지원 하는 경우 차동 모드 로 구성
ADC 정밀도 요구 사항 - 프로세서가 허용하는 최대 정밀도로 설정
ADC 속도 요구 사항 - 최대 정밀도에서 지원하는 최대 샘플링 속도 로 구성

2. SPI FLASH(WINBOND W25Q16JV 또는 동등 제품 사용)에 다음 데이터를 주기적으로 기록하는 펌웨어를 구현

요구 사항:
•  매 10초마다
   •  현재시간(RTC 기준)
   •  현재전압측정값(V)
   •  현재전류측정값〔mA)
   •  현재 전력 계산값(mW)
•  매 1분마다
   •  지난1분간평균 전압(V)
   •  지난1분간평군전류(mA)
   •  지난1분간평균 전력(mW)
단，MCU 전원 차단 후 재시작되었클 때 전원 차단 전 마지막 기록 블록 다음에 이어서 기록하고 끝에 도달하면 처음 부분부터 오버라이트
구현 시 고려사항:
•  플래시 메모리의 수명을 고려한 효물적인 쓰기 방식
•  정전 시에도 데이터가 보존되는 안전한 저장 방식
•  메모리 공간을 효물적으로 활용하는 데이터 구조

3. UART 통신을 통해 사용자가 입력한 날파/시간 정보를 수신하여 MCU의 RTC 모듈에 설정하는 시스템을 구현

 구현 시 고려사항:
- 입력 형식 정의
   날짜/시간 입력을 위한 명확한 포맷 정의〔예: "YYYY-MM-DD HH:MM” 또는 "SET_TIME YYYY/MM/DD HH:MM”)
- UART 통신설정
   •  통신버퍼크기및 오버플로우 처리방안
   •  통신 속도에 따른 Error Rate 대응 방안
- 입력데이터검증
   •  월별 일수 검증 （2월 28/29일，30일/31일 월 고려）
   •  윤년처리 로직
- RTC 설정
   •  RTC 모듈초기화 및 레지스터접근 방법
   •  검증된 날짜 /시간 정보를 RTC 레지스터에 설정하는 함수

4. UART를 통해 사용자가 요구하면，SPI Flash에 있는 내용클 분석해 배터리 사용상태를 출력하는 기능을 구현 

구현 시 고려사항:
•  UART 통신 프로토콜
   •  통신 오류처리메커니즘
•  메모리접근최적화
   •  순차적/비순차적 접근 방식 결정
•  대용량 데이터 처리를 위한 버퍼링 전략
   •  순차적/비순차적 접근 방식 결정
   •  데이터무결성확인메커니즘
• 출력 형식
   •  단위 표시 （Wh，V, W 등）
   •  시간 정보 포함〔언제부터 언제까지의 데이터인지）
•  처리효물성
   •  실시간응답보장들위한전략
   •  MC니 리소스사용최소화
•  오류처리:
   •  SPI Flash 데이터손상시대응 방안
   •  불완전한데이터 세트에대한처리 방법

5. 임의의 GPIO 편에 연결된 버튼클 이용하여 메모리 데이터 기록을 초기화하고 SPI Flash를 완전히 초기화하는 시스템을 구현 

구현 시 고려사항 :
•  GPIO 설정
   •  Internal Pull-up
   •  Open drain
•  GPIO 인터럽트처리
   •  버튼 입력 감지를 위한 인터럽트설정
   •  디바운싱구현
•  버튼입력 구분 기능
   •  짧은 누름과 긴 누름을 구분하는 타이머 메커니즘
•  메모리초기화 기능
   •  데이터 로그 초기화 루틴 （기록 포인터 재설정）
   •  메모리 상태 플래그관리
•  NAND 초기화 기능
   •  전체 SPI Flash 지우기 명령 시퀀스
   •  초기화상태확인메커니즘
•  안전기능
   * 초기화 작업 중 전원 차단에 대비한 안전장치
   * 실수로 인한 데이터 손실 방지를 위한 확인 메커니즘
•  사용자 피드백
   •  작업 진행 상태를 표시하는 방법 （LED 표시등 등）

### 요구사항 요약
1. **GPIO 설정**:
   - 버튼: 내부 풀업 저항, 오픈 드레인 출력.
   - LED: 작업 상태 표시용 (예: PC13).
2. **GPIO 인터럽트 처리**:
   - 버튼 입력 감지: EXTI 인터럽트.
   - 디바운싱: 소프트웨어 타이머로 50ms 디바운싱.
3. **버튼 입력 구분**:
   - 짧은 누름(< 2초): 데이터 기록 포인터 초기화.
   - 긴 누름(≥ 2초): 전체 SPI 플래시 초기화.
4. **메모리 초기화 기능**:
   - 데이터 로그 초기화: 메타데이터의 `last_write_addr`를 초기화.
   - 상태 플래그: 초기화 완료 여부 기록.
5. **NAND(SPI 플래시) 초기화 기능**:
   - 전체 플래시 지우기: W25Q128의 칩 지우기 명령(0x60 또는 0xC7).
   - 초기화 확인: 상태 레지스터 확인.
6. **안전 기능**:
    - 전원 차단 대비: 초기화 중 플래시 쓰기 완료 후 확인.
   - 실수 방지: 긴 누름에만 전체 초기화, 짧은 누름은 데이터 포인터만 초기화.
7. **사용자 피드백**:
   - LED: 초기화 진행/완료 시 점멸 패턴 (예: 진행 중 빠른 점멸, 완료 시 느린 점멸).

### 구현 가정
- **버튼**: PB1 (EXTI1, 내부 풀업, 오픈 드레인).
- **LED**: PC13 (상태 표시, 액티브 로우).
- **SPI 플래시**: W25Q128 (16MB, 기존 설정 유지).
- **데이터 구조**: 기존 `DataRecord10s`, `DataRecord1min`, `FlashMetadata` 유지.
- **타이머**: TIM2로 디바운싱 및 버튼 누름 시간 측정.
- **UART**: 상태 메시지 출력(115200 baud, PA9/PA10).

### 데이터 구조 및 플래시 관리
- **메타데이터**: `FlashMetadata`에 `init_flag` 추가 (초기화 상태 확인).
  
  typedef struct {
      uint32_t last_write_addr;
      uint32_t sector_index;
      uint32_t init_flag; // 0xA5A5A5A5: 초기화 완료
  } FlashMetadata;
  
- **초기화**:
  - 짧은 누름: `last_write_addr`를 `FLASH_DATA_ADDR`로 재설정, 섹터 1 지우기.
  - 긴 누름: 전체 플래시(섹터 0~4095) 지우기, 메타데이터 초기화.

- **안전성**: 초기화 후 `init_flag` 설정, 전원 재시작 시 확인.

### 코드 설명
1. **GPIO 설정**:
   - 버튼(PB1): 내부 풀업, EXTI1, 하강 에지 트리거.
   - LED(PC13): 오픈 드레인 출력, 액티브 로우.
2. **인터럽트 처리**:
   - `HAL_GPIO_EXTI_Callback`: 버튼 누름 감지, 타이머 시작.
   - `HAL_TIM_PeriodElapsedCallback`: 50ms 디바운싱, 2초 이상 누름 확인.
3. **버튼 입력 구분**:
   - 짧은 누름(< 2초): `Reset_Data_Log` 호출.
   - 긴 누름(≥ 2초): `Erase_SPI_Flash_Chip` 호출.
4. **메모리 초기화**:
   - `Reset_Data_Log`: 데이터 섹터(1) 지우기, `last_write_addr`를 `FLASH_DATA_ADDR`로 재설정, `init_flag` 설정.
   - `Erase_SPI_Flash_Chip`: W25Q128 전체 지우기(0xC7), 메타데이터 초기화.
5. **안전 기능**:
   - 긴 누름으로만 전체 초기화, 실수 방지.
   - 초기화 후 `init_flag` 설정, 재시작 시 확인.
   - SPI 쓰기/지우기 완료 후 상태 레지스터 확인.
6. **사용자 피드백**:
   - LED: 진행 중 빠른 점멸(100ms 간격, 4회), 완료 시 느린 점멸(500ms 간격, 2회).
   - UART: 초기화 완료 메시지 전송.
7. **기존 기능 유지**:
   - ADC, RTC, UART, SPI 플래시 데이터 기록/분석 기능 유지.

### 하드웨어 요구사항
- **버튼**: PB1, 내부 풀업 저항 연결.
- **LED**: PC13, 오픈 드레인, 외부 풀업 저항(4.7kΩ 권장).
- **SPI 플래시**: W25Q128 (PA5: SCK, PA6: MISO, PA7: MOSI, PB0: CS).
- **UART**: PA9(TX), PA10(RX), 115200 baud.
- **ADC**: PC0/1 (전압), PA3/4 (전류).
- **RTC**: VBAT에 코인셀 배터리.

